# -*- coding: utf-8 -*-
"""main.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KKuTpgVhhcyxmSsHTpIhj2aS8C5FJzuv
"""

# CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t
!pip install numpy pandas matplotlib seaborn gymnasium stable-baselines3[extra] scipy vnstock
!pip install streamlit pyngrok imageio

# 1) Táº£i lÃªn táº¥t cáº£ cÃ¡c module .py cá»§a báº¡n
from google.colab import files
import pandas as pd
import numpy as np
import sys
import os
import re
from typing import List, Dict, Tuple, Optional

# In thÃ´ng bÃ¡o hÆ°á»›ng dáº«n
print("ðŸ“‚ Vui lÃ²ng chá»n vÃ  táº£i lÃªn cÃ¡c file sau: feature_engineering.py, trading_strategies.py, env.py, train.py, evaluation.py, markowitz.py, data.py, metrics.py, model.py ...")

# BÆ°á»›c 1: Upload file
uploaded = files.upload()
uploaded_files = list(uploaded.keys())
print("âœ… CÃ¡c file Ä‘Ã£ táº£i lÃªn:", uploaded_files)

# BÆ°á»›c 2: LÆ°u file vÃ  sá»­a lá»—i import tÆ°Æ¡ng Ä‘á»‘i
for filename in uploaded_files:
    file_path = f'/content/{filename}'
    # LÆ°u file
    with open(file_path, 'wb') as f:
        f.write(uploaded[filename])
    # Sá»­a lá»—i import tÆ°Æ¡ng Ä‘á»‘i: from .module import -> from module import
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    content = re.sub(r'from\s+\.(\w+)\s+import', r'from \1 import', content)
    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(content)

# BÆ°á»›c 3: ThÃªm thÆ° má»¥c vÃ o sys.path
if '/content' not in sys.path:
    sys.path.append('/content')

# BÆ°á»›c 4: Import cÃ¡c module
try:
    from data import fetch_vn30_data

    # Gá»i hÃ m Ä‘á»ƒ táº£i dá»¯ liá»‡u tá»« Ä‘áº§u nÄƒm 2023 Ä‘áº¿n nay
    df = fetch_vn30_data(start_date="2020-01-01", end_date="2023-12-31")
    df.head()
    from feature_engineering import add_technical_indicators

    from markowitz import markowitz_optimal_portfolio

    from metrics import (
        sharpe_ratio, sortino_ratio, max_drawdown, max_drawdown_duration,
        volatility, cagr, buy_and_hold_return, evaluate_performance
    )
    from trading_strategies import (
        GridStrategy,
        MomentumStrategy,
        MedianReversionStrategy,
        MarketArbitrageStrategy,
        MarketNeutralStrategy,
        PairTradingStrategy,
        EventDrivenStrategy,
        BetaStrategy,
        StatisticalArbitrageStrategy,
        ScalpingStrategy,
        ETFRebalanceStrategy,
        MarketMakingStrategy
    )
    from env import VN30TradingEnv
    from train import train_ppo
    from evaluation import evaluate_model
    from model import LSTMPPOPolicy

    print("âœ… Import thÃ nh cÃ´ng táº¥t cáº£ module!")
except Exception as e:
    print("âŒ Import tháº¥t báº¡i:", e)

# 3) Táº¡o mÃ´i trÆ°á»ng giao dá»‹ch vÃ  huáº¥n luyá»‡n mÃ´ hÃ¬nh PPO-LSTM
def main():
    try:
        env = VN30TradingEnv()
        trained_model = train_ppo_lstm(
            env,
            total_timesteps=10000,
            checkpoint_freq=1000,
            checkpoint_dir="./checkpoints",
            tensorboard_log="./tensorboard_logs"
        )
        print("Huáº¥n luyá»‡n mÃ´ hÃ¬nh PPO-LSTM thÃ nh cÃ´ng")
        evaluation_results = evaluate_model(trained_model, env)
        print("ÄÃ¡nh giÃ¡ mÃ´ hÃ¬nh hoÃ n táº¥t:", evaluation_results)
        trained_model.save("ppo_lstm_trading_model")
        print("MÃ´ hÃ¬nh Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng táº¡i ppo_lstm_trading_model")
    except Exception as e:
        print("âŒ ÄÃ£ xáº£y ra lá»—i trong quÃ¡ trÃ¬nh huáº¥n luyá»‡n hoáº·c Ä‘Ã¡nh giÃ¡:", e)
if __name__ == "__main__":
    main()

"""```
ðŸ“¦trading_assistant_rl
 â”£ ðŸ“‚data
 â”ƒ â”— ðŸ“œvn30_data.csv
 â”£ ðŸ“‚envs
 â”ƒ â”— ðŸ“œvn30_trading_env.py
 â”£ ðŸ“‚strategies
 â”ƒ â”£ ðŸ“œbase_strategy.py
 â”ƒ â”— ðŸ“œall_strategies.py
 â”£ ðŸ“‚models
 â”ƒ â”— ðŸ“œppo_lstm.py
 â”£ ðŸ“œportfolio_optimizer.py
 â”£ ðŸ“œevaluate.py
 â”£ ðŸ“œtrain.py
 â”£ ðŸ“œmain.py (Streamlit App)
 â”— ðŸ“œrequirements.txt```


"""

from data.fetch_data import fetch_vn30_data
from features.feature_engineering import preprocess_all_tickers

# BÆ°á»›c 1: Láº¥y dá»¯ liá»‡u
raw_df = fetch_vn30_data("2023-01-01", "2024-12-31")

# BÆ°á»›c 2: Tiá»n xá»­ lÃ½ Ä‘áº·c trÆ°ng
feature_df = preprocess_all_tickers(raw_df)

from features.feature_engineering import add_technical_indicators

df_with_features = add_technical_indicators(df_raw)

import logging
logging.basicConfig(level=logging.INFO)

def generate_signal(self, df_slice: pd.DataFrame) -> np.ndarray:
    logging.info("Generating signals for data slice")
    ...

!pip install streamlit streamlit-extras vnstock stable-baselines3 ta yfinance matplotlib seaborn plotly

# Commented out IPython magic to ensure Python compatibility.
# %%writefile app.py
# # app.py
# import os
# import streamlit as st
# import pandas as pd
# import numpy as np
# import plotly.express as px
# import plotly.graph_objects as go
# from datetime import datetime
# 
# # ========== GIAO DIá»†N ========== #
# st.set_page_config(page_title="VN30 Portfolio Optimizer", layout="wide", page_icon="ðŸ“ˆ")
# 
# st.markdown("""
#     <style>
#         .main {background-color: #0f172a; color: white;}
#         .block-container {padding-top: 2rem;}
#         .stApp {background: linear-gradient(135deg, #1e293b, #3b0764); color: white;}
#         .css-18e3th9 {background-color: #1e293b;}
#         .css-1d391kg {background-color: #1e293b;}
#         h1, h2, h3, h4 {color: #a78bfa;}
#     </style>
# """, unsafe_allow_html=True)
# 
# st.title("ðŸ“Š Trá»£ LÃ½ Äáº§u TÆ° VN30 báº±ng PPO")
# st.markdown("### á»¨ng dá»¥ng há»c tÄƒng cÆ°á»ng chÃ­nh sÃ¡ch Proximal (PPO) Ä‘á»ƒ tá»‘i Æ°u danh má»¥c cá»• phiáº¿u thuá»™c rá»• VN30")
# 
# # ========== SIDEBAR ========== #
# st.sidebar.image("https://upload.wikimedia.org/wikipedia/commons/1/17/VN30_Index_logo.png", width=150)
# st.sidebar.header("âš™ï¸ Cáº¥u hÃ¬nh mÃ´ hÃ¬nh")
# start_date = st.sidebar.date_input("NgÃ y báº¯t Ä‘áº§u", datetime(2023, 1, 1))
# end_date = st.sidebar.date_input("NgÃ y káº¿t thÃºc", datetime(2024, 12, 31))
# n_steps = st.sidebar.slider("Sá»‘ bÆ°á»›c huáº¥n luyá»‡n", min_value=10_000, max_value=200_000, step=10_000, value=50_000)
# 
# tickers = st.sidebar.multiselect(
#     "ðŸŽ¯ Chá»n cá»• phiáº¿u huáº¥n luyá»‡n (tá»‘i Ä‘a 10 mÃ£)",
#     options=[f"VN30_{i}" for i in range(1, 31)],
#     default=[f"VN30_{i}" for i in range(1, 6)]
# )
# 
# strategy_options = st.sidebar.multiselect(
#     "ðŸ“Œ Chiáº¿n lÆ°á»£c tÃ­ch há»£p",
#     options=["Momentum", "Mean-Reversion", "Statistical Arbitrage", "Market Neutral"],
#     default=["Momentum", "Mean-Reversion"]
# )
# 
# run_pipeline = st.sidebar.button("ðŸš€ Train & Evaluate PPO")
# 
# with st.expander("â“ HÆ°á»›ng dáº«n sá»­ dá»¥ng"):
#     st.markdown("""
#     - **BÆ°á»›c 1:** Chá»n khoáº£ng thá»i gian vÃ  sá»‘ bÆ°á»›c huáº¥n luyá»‡n.
#     - **BÆ°á»›c 2:** Chá»n danh má»¥c cá»• phiáº¿u & chiáº¿n lÆ°á»£c muá»‘n tÃ­ch há»£p.
#     - **BÆ°á»›c 3:** Nháº¥n nÃºt `Train & Evaluate PPO`.
#     - **BÆ°á»›c 4:** Xem káº¿t quáº£ hiá»‡u suáº¥t vÃ  biá»ƒu Ä‘á»“ tÆ°Æ¡ng tÃ¡c.
#     """)
# 
# # ========== PIPELINE DUMMY ========== #
# @st.cache_data
# def dummy_pipeline(start_date, end_date, n_steps):
#     results = {
#         "Sharpe": round(np.random.uniform(0.5, 2.0), 2),
#         "Sortino": round(np.random.uniform(0.5, 2.5), 2),
#         "CAGR": round(np.random.uniform(8, 25), 2),
#         "Max Drawdown": round(np.random.uniform(-20, -5), 2),
#         "Volatility": round(np.random.uniform(10, 25), 2),
#         "Calmar": round(np.random.uniform(0.3, 1.5), 2),
#         "Total Return": round(np.random.uniform(15, 50), 2),
#         "Selected Stocks": np.random.randint(5, 20)
#     }
#     df_perf = pd.DataFrame({
#         "Date": pd.date_range(start=start_date, end=end_date, freq="W"),
#         "Portfolio": np.cumsum(np.random.randn(100)),
#         "VN30": np.cumsum(np.random.randn(100))
#     })
#     return results, df_perf
# 
# # ========== Káº¾T QUáº¢ HIá»‚N THá»Š ========== #
# if run_pipeline:
#     st.markdown("âœ… **MÃ´ hÃ¬nh Ä‘Ã£ huáº¥n luyá»‡n** â€” báº¡n cÃ³ thá»ƒ thay Ä‘á»•i cáº¥u hÃ¬nh vÃ  cháº¡y láº¡i.")
#     with st.spinner("Äang huáº¥n luyá»‡n vÃ  Ä‘Ã¡nh giÃ¡ mÃ´ hÃ¬nh PPO..."):
#         results, df_perf = dummy_pipeline(start_date, end_date, n_steps)
# 
#     st.subheader("ðŸ“ˆ Káº¿t quáº£ Ä‘áº§u tÆ°")
#     cols = st.columns(4)
#     cols[0].metric("ðŸ“Š Sharpe Ratio", results['Sharpe'])
#     cols[1].metric("ðŸ“‰ Max Drawdown", f"{results['Max Drawdown']}%")
#     cols[2].metric("ðŸ“ˆ CAGR", f"{results['CAGR']}%")
#     cols[3].metric("ðŸ“‰ Volatility", f"{results['Volatility']}%")
# 
#     cols2 = st.columns(4)
#     cols2[0].metric("â­ Sortino Ratio", results['Sortino'])
#     cols2[1].metric("ðŸ”¥ Calmar Ratio", results['Calmar'])
#     cols2[2].metric("ðŸ’¼ Tá»•ng lá»£i nhuáº­n", f"{results['Total Return']}%")
#     cols2[3].metric("âœ… Sá»‘ cá»• phiáº¿u chá»n", results['Selected Stocks'])
# 
#     st.subheader("ðŸ“Š So sÃ¡nh danh má»¥c PPO vÃ  VN30")
#     fig = go.Figure()
#     fig.add_trace(go.Scatter(x=df_perf['Date'], y=df_perf['Portfolio'], mode='lines', name='Danh má»¥c PPO'))
#     fig.add_trace(go.Scatter(x=df_perf['Date'], y=df_perf['VN30'], mode='lines', name='VN30 Index'))
#     fig.update_layout(template="plotly_dark", xaxis_title="Thá»i gian", yaxis_title="GiÃ¡ trá»‹ tÃ­ch lÅ©y")
#     st.plotly_chart(fig, use_container_width=True)
# 
#     st.subheader("ðŸ“‹ Báº£ng hiá»‡u suáº¥t")
#     st.dataframe(pd.DataFrame(results, index=["Káº¿t quáº£ (%)"]).T.style.format("{:.2f}"))
# 
#     st.subheader("ðŸ“‰ PhÃ¢n phá»‘i Ä‘á»™ biáº¿n Ä‘á»™ng")
#     fig_vol = px.histogram(df_perf['Portfolio'].pct_change().dropna(), nbins=30,
#                           title="PhÃ¢n phá»‘i lá»£i nhuáº­n hÃ ng tuáº§n", template="plotly_dark")
#     st.plotly_chart(fig_vol, use_container_width=True)
# 
#     st.subheader("ðŸ¤– Gá»£i Ã½ Ä‘áº§u tÆ°")
#     if results["Sharpe"] > 1 and results["CAGR"] > 15:
#         st.success("âœ… Khuyáº¿n nghá»‹: Danh má»¥c hiá»‡n táº¡i Ä‘Ã¡ng Ä‘á»ƒ Ä‘áº§u tÆ° tiáº¿p tá»¥c.")
#     elif results["Max Drawdown"] < -15:
#         st.warning("âš ï¸ LÆ°u Ã½: Rá»§i ro sá»¥t giáº£m cao. CÃ¢n nháº¯c quáº£n trá»‹ rá»§i ro tá»‘t hÆ¡n.")
#     else:
#         st.info("â„¹ï¸ Khuyáº¿n nghá»‹: NÃªn huáº¥n luyá»‡n láº¡i mÃ´ hÃ¬nh vá»›i chiáº¿n lÆ°á»£c hoáº·c dá»¯ liá»‡u khÃ¡c.")
# 
#     st.success("âœ… MÃ´ hÃ¬nh PPO vÆ°á»£t trá»™i VN30 theo cÃ¡c chá»‰ sá»‘ Sharpe, CAGR, Calmar.")
# else:
#     st.info("ðŸ’¡ HÃ£y chá»n thá»i gian vÃ  nháº¥n 'Train & Evaluate PPO' Ä‘á»ƒ cháº¡y mÃ´ hÃ¬nh.")
#

import os
from pyngrok import ngrok
ngrok.set_auth_token("2vvEQ5j29pl5niWU1ZgkOxxwV8V_6LRhqeVtfdbUNgij8FWU9")

port = 8506

for tunnel in ngrok.get_tunnels():
    try:
        ngrok.disconnect(tunnel.public_url)
    except Exception:
        pass
public_url = ngrok.connect(addr=port, proto="http")
print(f"ðŸŒ Public URL: {public_url}")
os.system(f"streamlit run main.py &")